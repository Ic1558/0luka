name: governance-comment-approve

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  approve:
    if: >
      github.event.issue.pull_request != null &&
      github.event.comment.body == '@0luka-bot approve'
    runs-on: ubuntu-latest
    steps:
      - name: Approve PR (fail-closed)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_PAT }}
          script: |
            const allowedUser = "Ic1558";
            const trigger = "@0luka-bot approve";
            const commentBody = (context.payload.comment?.body || "").trim();
            const commentAuthor = context.payload.comment?.user?.login || "";

            if (commentBody !== trigger) {
              core.setFailed("Comment body does not exactly match the required trigger phrase.");
              return;
            }

            if (commentAuthor !== allowedUser) {
              core.setFailed("Comment author is not allowed for bot approval.");
              return;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (pr.data.user.login !== allowedUser) {
              core.setFailed("PR author not allowed for bot approval.");
              return;
            }

            const rollupQuery = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    headRefOid
                    commits(last: 1) {
                      nodes {
                        commit {
                          statusCheckRollup {
                            contexts(first: 100) {
                              nodes {
                                __typename
                                ... on CheckRun {
                                  name
                                  status
                                  conclusion
                                }
                                ... on StatusContext {
                                  context
                                  state
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const rollupResp = await github.graphql(rollupQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: context.issue.number
            });

            const prNode = rollupResp.repository.pullRequest;
            const contexts = prNode?.commits?.nodes?.[0]?.commit?.statusCheckRollup?.contexts?.nodes || [];

            if (contexts.length === 0) {
              core.setFailed("No status checks found on PR head commit; fail-closed.");
              return;
            }

            const failing = contexts.filter((c) => {
              if (c.__typename === "CheckRun") {
                return c.status !== "COMPLETED" || c.conclusion !== "SUCCESS";
              }
              if (c.__typename === "StatusContext") {
                return c.state !== "SUCCESS";
              }
              return true;
            });

            if (failing.length > 0) {
              const details = failing.map((c) => {
                if (c.__typename === "CheckRun") {
                  return `${c.name}: status=${c.status}, conclusion=${c.conclusion}`;
                }
                if (c.__typename === "StatusContext") {
                  return `${c.context}: state=${c.state}`;
                }
                return "Unknown check context";
              });
              core.setFailed(`Status checks are not all successful. ${details.join(" | ")}`);
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: "APPROVE",
              body: "Auto-approved via governance bot (explicit comment trigger, strict actor checks, checks-success gate)."
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Audit: approved by governance bot after exact trigger from @${commentAuthor}; PR author @${pr.data.user.login}; all status checks successful on head ${prNode.headRefOid}.`
            });
