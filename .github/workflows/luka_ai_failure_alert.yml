name: Luka AI Failure Alert

on:
  workflow_run:
    workflows:
      - "tier2-integrity"
      - "governance-controls"
      - "phase1a"
      - "CI Size Guard"
      - "ci / retention-smoke"
      - "auto-governor-router"
    types: [completed]

jobs:
  always:
    runs-on: ubuntu-latest
    steps:
      - name: Keep run valid when alert is not needed
        run: echo "No failure alert required for this workflow_run event."

  alert:
    needs: always
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.name != 'Luka AI Failure Alert'
    steps:
      - name: Send Failure Alert
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          secure: true
          username: ${{ secrets.AI_TEAM_EMAIL }}
          password: ${{ secrets.AI_TEAM_EMAIL_PASS }}
          subject: "‚ùå [0luka] Workflow Failed: ${{ github.event.workflow_run.name }}"
          to: ${{ secrets.AI_TEAM_EMAIL }}
          from: "Luka AI <${{ secrets.AI_TEAM_EMAIL }}>"
          body: |
            # Workflow Failure Alert
            **Workflow:** ${{ github.event.workflow_run.name }}
            **Branch:** ${{ github.event.workflow_run.head_branch }}
            **Commit:** ${{ github.event.workflow_run.head_sha }}
            [View Failed Run](${{ github.event.workflow_run.html_url }})
