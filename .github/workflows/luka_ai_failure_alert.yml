name: Luka AI Failure Alert

on:
  workflow_run:
    workflows:
      - "tier2-integrity"
      - "governance-controls"
      - "phase1a"
      - "CI Size Guard"
      - "ci / retention-smoke"
      - "auto-governor-router"
    types: [completed]

jobs:
  always:
    runs-on: ubuntu-latest
    steps:
      - name: Keep run valid when alert is not needed
        run: echo "No failure alert required for this workflow_run event."

  # Track success state so suppress_newer_success works correctly
  success_state:
    needs: always
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Restore alert dedup state
        uses: actions/cache/restore@v4
        with:
          path: observability/telemetry/alert_dedup_state.json
          key: alert-dedup-v1-${{ github.run_id }}
          restore-keys: alert-dedup-v1-

      - name: Update success state for all jobs in run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          JOBS=$(gh api \
            "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" \
            --jq '[.jobs[] | .name] | .[]' \
            2>/dev/null || echo "unknown")
          if [ -z "$JOBS" ]; then JOBS="unknown"; fi
          while IFS= read -r CHECK; do
            [ -z "$CHECK" ] && continue
            python3 tools/ops/alert_dedup.py \
              --mode success \
              --workflow "${{ github.event.workflow_run.name }}" \
              --branch "${{ github.event.workflow_run.head_branch }}" \
              --check-name "$CHECK" \
              --run-id "${{ github.event.workflow_run.id }}" \
              --event-ts-utc "${{ github.event.workflow_run.created_at }}" || true
          done <<< "$JOBS"

      - name: Save alert dedup state
        uses: actions/cache/save@v4
        with:
          path: observability/telemetry/alert_dedup_state.json
          key: alert-dedup-v1-${{ github.run_id }}

  # Send failure alert with dedup guard
  alert:
    needs: always
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name != 'Luka AI Failure Alert'
    steps:
      - uses: actions/checkout@v4

      - name: Restore alert dedup state
        uses: actions/cache/restore@v4
        with:
          path: observability/telemetry/alert_dedup_state.json
          key: alert-dedup-v1-${{ github.run_id }}
          restore-keys: alert-dedup-v1-

      - name: Resolve failing check name
        id: check_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECK=$(gh api \
            "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | first // "unknown"' \
            2>/dev/null || echo "unknown")
          echo "check_name=${CHECK}" >> "$GITHUB_OUTPUT"

      - name: Run dedup check
        id: dedup
        run: |
          set +e
          RESULT=$(python3 tools/ops/alert_dedup.py \
            --mode fail \
            --workflow "${{ github.event.workflow_run.name }}" \
            --branch "${{ github.event.workflow_run.head_branch }}" \
            --check-name "${{ steps.check_info.outputs.check_name }}" \
            --run-id "${{ github.event.workflow_run.id }}" \
            --event-ts-utc "${{ github.event.workflow_run.created_at }}")
          set -e
          DECISION=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin)['decision'])" 2>/dev/null || echo "emit_alert")
          SEVERITY=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('severity','WARNING'))" 2>/dev/null || echo "WARNING")
          echo "decision=${DECISION}" >> "$GITHUB_OUTPUT"
          echo "severity=${SEVERITY}" >> "$GITHUB_OUTPUT"

      - name: Save alert dedup state
        uses: actions/cache/save@v4
        if: steps.dedup.outputs.decision == 'emit_alert'
        with:
          path: observability/telemetry/alert_dedup_state.json
          key: alert-dedup-v1-${{ github.run_id }}

      - name: Prepare Alert Body (CRITICAL)
        if: steps.dedup.outputs.decision == 'emit_alert' && steps.dedup.outputs.severity == 'CRITICAL'
        run: |
          cat << 'EOF' > /tmp/alert_body.txt
          # CRITICAL Workflow Failure
          **Workflow:** ${{ github.event.workflow_run.name }}
          **Check:** ${{ steps.check_info.outputs.check_name }}
          **Branch:** ${{ github.event.workflow_run.head_branch }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          [View Failed Run](${{ github.event.workflow_run.html_url }})
          EOF
          echo "ALERT_SUBJECT=ðŸš¨ [CRITICAL] [0luka] ${{ github.event.workflow_run.name }} failed" >> $GITHUB_ENV
          echo "ALERT_BODY_FILE=/tmp/alert_body.txt" >> $GITHUB_ENV

      - name: Prepare Alert Body (WARNING)
        if: steps.dedup.outputs.decision == 'emit_alert' && steps.dedup.outputs.severity == 'WARNING'
        run: |
          cat << 'EOF' > /tmp/alert_body.txt
          # Workflow Failure Alert
          **Workflow:** ${{ github.event.workflow_run.name }}
          **Check:** ${{ steps.check_info.outputs.check_name }}
          **Branch:** ${{ github.event.workflow_run.head_branch }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          [View Failed Run](${{ github.event.workflow_run.html_url }})
          EOF
          echo "ALERT_SUBJECT=âš ï¸ [WARNING] [0luka] ${{ github.event.workflow_run.name }} failed" >> $GITHUB_ENV
          echo "ALERT_BODY_FILE=/tmp/alert_body.txt" >> $GITHUB_ENV

      - name: Send email (policy-safe)
        if: steps.dedup.outputs.decision == 'emit_alert'
        env:
          SMTP_HOST: smtp-mail.outlook.com
          SMTP_PORT: 587
          SMTP_USER: ${{ secrets.AI_TEAM_EMAIL }}
          SMTP_PASS: ${{ secrets.AI_TEAM_EMAIL_PASS }}
          TO_EMAIL:  ${{ secrets.AI_TEAM_EMAIL }}
        run: |
          [ -n "${ALERT_SUBJECT:-}" ] || { echo "missing ALERT_SUBJECT â€” no Prepare step ran"; exit 1; }
          [ -f "${ALERT_BODY_FILE:-}" ] || { echo "missing ALERT_BODY_FILE â€” body not written"; exit 1; }
          python3 tools/ops/send_mail.py \
            --to "$TO_EMAIL" \
            --subject "$ALERT_SUBJECT" \
            --body-file "$ALERT_BODY_FILE"
