# ATG Multi Snapshot v1.8: Evidence Guardian Edition

**Goal**: Transform the snapshot tool into a comprehensive "black box" system that auto-saves timestamped snapshots, performs diff analysis against previous runs, and recursively discovers telemetry/logs for complete system visibility.

## User Review Required

> [!IMPORTANT]
> **Breaking Change**: The script will now auto-create `artifacts/snapshots/` directory and save every execution as a timestamped file. This creates a persistent audit trail.

> [!NOTE]
> **Raycast Mode Decision**: The user's example shows `@raycast.mode fullOutput`, but previous sessions confirmed `silent` mode is required for true auto-run. I will implement with `fullOutput` as specified, but recommend testing both modes.

## Proposed Changes

### Core Enhancement

#### [MODIFY] [atg_multi_snap.zsh](file:///Users/icmini/0luka/.0luka/scripts/atg_multi_snap.zsh)

**New Features**:

1. **Auto-Timeline System**
   - Create `artifacts/snapshots/` directory automatically
   - Save each snapshot as `yymmdd_HHMMSS_snapshot.md`
   - Maintain complete audit trail of all executions

2. **Diff Engine**
   - Find most recent snapshot file (`ls -t | head -n 1`)
   - Compare current state with last snapshot using `diff -u`
   - Extract meaningful changes (git status, processes, ports)
   - Display diff summary in output with change highlights

3. **Recursive Discovery**
   - Search for `telemetry/` and `logs/` directories up to 3 levels deep
   - Tail last 10 lines from recent log files (`.log`, `.json`, `.jsonl`, `.txt`)
   - Display findings per repository

4. **Network X-Ray**
   - Scan active TCP ports in LISTEN state using `lsof`
   - Filter for agent-related processes (python, node, uvicorn, etc.)
   - Prevent port conflicts and provide visibility

**Technical Implementation**:
- Use `find` with `-maxdepth 3` for recursive discovery
- Use `ls -t` with glob patterns for finding recent logs
- Use `diff -u` for unified diff format
- Filter diff output to exclude timestamps and metadata lines
- Maintain backward compatibility with clipboard delivery

## Verification Plan

### Automated Tests

```bash
# Test 1: Auto-save functionality
AGENT_ID=gmx zsh .0luka/scripts/atg_multi_snap.zsh
ls -lh artifacts/snapshots/
# Expected: New file with yymmdd_HHMMSS_snapshot.md format

# Test 2: Diff engine (run twice)
AGENT_ID=gmx zsh .0luka/scripts/atg_multi_snap.zsh
# Make a change (e.g., create a file in 0luka)
touch test_diff_marker.txt
AGENT_ID=gmx zsh .0luka/scripts/atg_multi_snap.zsh
# Expected: Diff section shows the new file in git status

# Test 3: Recursive discovery
find ~/0luka ~/02luka -maxdepth 3 -type d -name "telemetry" -o -name "logs"
# Expected: Script output includes tailed logs from discovered directories

# Test 4: Clipboard persistence
pbpaste | head -n 5
# Expected: Snapshot content in clipboard
```

### Manual Verification

- Confirm `artifacts/snapshots/` directory is created
- Verify timestamp format matches `yymmdd_HHMMSS` pattern
- Check diff output highlights actual changes
- Validate recursive discovery finds all telemetry/logs directories
- Test in Raycast environment with hotkey trigger
