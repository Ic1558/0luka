#!/bin/zsh
# 0luka Pre-commit Hook: Block Large Files
# Install: ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit

set -e

# Size limit in bytes (10MB)
SIZE_LIMIT=$((10 * 1024 * 1024))
SIZE_LIMIT_HUMAN="10MB"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Checking for large files..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

BLOCKED=0
for FILE in $STAGED_FILES; do
    if [[ -f "$FILE" ]]; then
        SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat --printf="%s" "$FILE" 2>/dev/null || echo 0)
        if [[ $SIZE -gt $SIZE_LIMIT ]]; then
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "${RED}‚ùå BLOCKED${NC}: $FILE (${SIZE_MB}MB > $SIZE_LIMIT_HUMAN)"
            BLOCKED=1
        fi
    fi
done

# Check for artifact directories that should never be committed
ARTIFACT_DIRS=(
    "staging/"
    "observability/artifacts/"
    "runtime/logs/"
    "logs/"
)

for FILE in $STAGED_FILES; do
    for DIR in "${ARTIFACT_DIRS[@]}"; do
        if [[ "$FILE" == "$DIR"* ]]; then
            echo "${YELLOW}‚ö†Ô∏è WARNING${NC}: Committing artifact: $FILE"
            echo "   ‚Üí Consider moving to external storage"
        fi
    done
done

if [[ $BLOCKED -eq 1 ]]; then
    echo ""
    echo "${RED}Commit blocked.${NC} Options:"
    echo "  1. Remove file from staging: git reset HEAD <file>"
    echo "  2. Add to .gitignore"
    echo "  3. Use Git LFS: git lfs track '<pattern>'"
    echo "  4. Archive to external storage"
    exit 1
fi

echo "‚úÖ No large files detected"
exit 0
